\section*{Process-\/in-\/\-Process (Pi\-P)}

Pi\-P is a user-\/level library to have the best of the both worlds of multi-\/process and multi-\/thread parallel execution models. Pi\-P allows a process to create sub-\/processes into the same virtual address space where the parent process runs. The parent process and sub-\/processes share the same address space, however, each process has its own variable set. So, each process runs independently from the other process. If some or all processes agree, then data own by a process can be accessed by the other processes. Those processes share the same address space, just like pthreads, and each process has its own variables like a process. The parent process is called Pi\-P process and a sub-\/process are called a Pi\-P task.

\subsection*{Pi\-P Versions}

Currently there are three Pi\-P library versions\-:


\begin{DoxyItemize}
\item Version 1 -\/ Deprecated
\item Version 2 -\/ Stable version
\item Version 3 -\/ Stable version supporting B\-L\-T and U\-L\-P
\end{DoxyItemize}

In this document, {\bfseries N} denotes the Pi\-P version number.

\subsection*{Bi-\/\-Level Thread (B\-L\-T, from v3)}

Pi\-P also provides new thread implementation named \char`\"{}\-Bi-\/\-Level Thread
(\-B\-L\-T)\char`\"{}, again, to take the best of two worlds, Kernel-\/\-Level Thread (K\-L\-T) and User-\/\-Level Thread (U\-L\-T) here. A B\-L\-T is a Pi\-P task. When a Pi\-P task is created it runs as a K\-L\-T. At any point the K\-L\-T can becomme a U\-L\-T by decoupling the associated kernel thread from the K\-L\-T. The decoupled kernel thread becommes idle. Later, the U\-L\-T can become K\-L\-T again by coupling with the kernel thread.

\subsection*{User-\/\-Level Process (U\-L\-P, from v3)}

As described, Pi\-P allows Pi\-P tasks to share the same virtual address space. This mans that a Pi\-P task can context-\/switch to the other Pi\-P task at user-\/level. This is called User-\/\-Level Process where processes may be derived from the same program or different programs. Threads basically share most of the kernel resources, such as address space, file descriptors, a process id, and so on whilst processes do not. Every process has its ows file descriptor space, for example. When a U\-L\-P is scheduled by a K\-L\-T having P\-I\-D 1000, then the getpid() is called by the U\-L\-P returns 1000. Further, when the U\-L\-T is migrated to be scheduled by the other K\-L\-T, then the returned P\-I\-D is different. So, when implemnting a U\-L\-P system, this systemcall consistency must be preserved. In U\-L\-P on Pi\-P, the consistency can be maintained by utilizing the above B\-L\-T mechanism. When a U\-L\-T tries to call a system call, it is coupled with its kernel thread which was created at the beginning as a K\-L\-T. It should be note that Thread Local Storage (T\-L\-S) regions are also switched when switching U\-L\-P (and B\-L\-T) contexts.

\subsection*{Execution Mode}

There are several Pi\-P implementation modes which can be selected at the runtime. These implementations can be categorized into two according to the behavior of Pi\-P tasks,


\begin{DoxyItemize}
\item Process and
\item (P)Thread
\end{DoxyItemize}

In the pthread mode, although each Pi\-P task has its own variables unlike thread, Pi\-P task behaves more like P\-Thread, having a T\-I\-D, having the same file descriptor space, having the same signal delivery semantics as Pthread does, and so on. In the process mode, Pi\-P task behaves more like a process, having a P\-I\-D, having an independent file descriptor space, having the same signal delivery semantics as Linux process does, and so on. The above mentioned U\-L\-P can only work with the process mode.

When the {\ttfamily P\-I\-P\-\_\-\-M\-O\-D\-E} environment variable set to \char`\"{}thread\char`\"{} or \char`\"{}pthread\char`\"{} then the Pi\-P library runs based on the pthread mode, and it is set to \char`\"{}process\char`\"{} then it runs with the process mode. There are also three implementations in the process mode; \char`\"{}process\-:preload,\char`\"{} \char`\"{}process\-:pipclone\char`\"{} and \char`\"{}process\-:got.\char`\"{} The \char`\"{}process\-:preload\char`\"{} mode must be with the L\-D\-\_\-\-P\-R\-E\-L\-O\-A\-D environment variable setting so that the clone() system call wrapper can work with. The \char`\"{}process\-:pipclone\char`\"{} mode can only be specified with the P\-I\-P-\/patched glibc library (see below\-: G\-L\-I\-B\-C issues).

There several function provided by the Pi\-P library to absorb the difference due to the execution mode

\section*{License}

This project is licensed under the 2-\/clause simplified B\-S\-D License -\/ see the \mbox{[}L\-I\-C\-E\-N\-S\-E\mbox{]}(L\-I\-C\-E\-N\-S\-E) file for details.

\section*{Installation}

\subsection*{Pi\-P Trial by using Docker image}

Download and run the Pi\-P Docker image. \begin{DoxyVerb}$ docker pull rikenpip/pip-vN
$ sudo docker run -it rikenpip/pip-vN /bin/bash
\end{DoxyVerb}


\subsection*{Source Repositories}

The installation of Pi\-P related packages must follow the order below;


\begin{DoxyEnumerate}
\item Build Pi\-P-\/glibc (optional)
\item Build Pi\-P
\item Build Pi\-P-\/gdb (optional)
\end{DoxyEnumerate}

Note that if Pi\-P-\/gdb will not work at all without Pi\-P-\/glibc. Further, Pi\-P can only create up to around ten Pi\-P tasks without installing Pi\-P-\/glibc.


\begin{DoxyItemize}
\item \href{https://github.com/RIKEN-SysSoft/PiP-glibc}{\tt Pi\-P-\/glibc} -\/ patched G\-N\-U libc for Pi\-P
\item \href{https://github.com/RIKEN-SysSoft/PiP}{\tt Pi\-P} -\/ Process in Process (this package)
\item \href{https://github.com/RIKEN-SysSoft/PiP-gdb}{\tt Pi\-P-\/gdb} -\/ patched gdb to debug Pi\-P root and Pi\-P tasks.
\end{DoxyItemize}

Before installing Pi\-P, we strongly recommend you to install Pi\-P-\/glibc.

After installing Pi\-P, Pi\-P-\/gdb can be installed too.

\subsection*{Installation from the source code.}


\begin{DoxyEnumerate}
\item Building Pi\-P-\/glibc (optional)

Fetch source tree (Cent\-O\-S7 or R\-H\-E\-L7)\-:

\$ git clone -\/b pip-\/centos7 \href{mailto:git@git.sys.aics.riken.jp}{\tt git@git.\-sys.\-aics.\-riken.\-jp}\-:software/\-P\-I\-P-\/glibc

Fetch source tree (Cent\-O\-S8 or R\-H\-E\-L8)\-:

\$ git clone -\/b pip-\/centos8 \href{mailto:git@git.sys.aics.riken.jp}{\tt git@git.\-sys.\-aics.\-riken.\-jp}\-:software/\-P\-I\-P-\/glibc

Build Pi\-P-\/glibc

\$ mkdir G\-L\-I\-B\-C\-\_\-\-B\-U\-I\-L\-D\-\_\-\-D\-I\-R \$ cd G\-L\-I\-B\-C\-\_\-\-B\-U\-I\-L\-D\-\_\-\-D\-I\-R \$ G\-L\-I\-B\-C\-\_\-\-S\-R\-C\-\_\-\-D\-I\-R/build.\-sh --prefix=G\-L\-I\-B\-C\-\_\-\-I\-N\-S\-T\-A\-L\-L\-\_\-\-D\-I\-R
\item Build Pi\-P library

The same source code can be ussed for Cent\-O\-S7 and Cent\-O\-S8 (R\-H\-E\-L7 and R\-H\-E\-L8).

\$ git clone -\/b pip-\/\-N \href{mailto:git@git.sys.aics.riken.jp}{\tt git@git.\-sys.\-aics.\-riken.\-jp}\-:software/\-Pi\-P \$ cd P\-I\-P\-\_\-\-S\-R\-C\-\_\-\-D\-I\-R \$ ./configure --prefix=P\-I\-P\-\_\-\-I\-N\-S\-T\-A\-L\-L\-\_\-\-D\-I\-R \mbox{[} --with-\/glibc-\/libdir=G\-L\-I\-B\-C\-\_\-\-I\-N\-S\-T\-A\-L\-L\-\_\-\-D\-I\-R/lib \mbox{]} \$ make install doxgyen-\/install \$ cd P\-I\-P\-\_\-\-I\-N\-S\-T\-A\-L\-L\-\_\-\-D\-I\-R/bin \$ ./piplnlibs

If you want to make sure if the Pi\-P library is correctly installed, then do the following;

\$ cd P\-I\-P\-\_\-\-S\-R\-C\-\_\-\-D\-I\-R \$ make install-\/test

Important note\-: The prefix directory of Pi\-P-\/glibc and the prefix directory of Pi\-P itself must N\-O\-T be the same.
\item Build Pi\-P-\/gdb (optional)

Fetch source tree (Cent\-O\-S7 or R\-H\-E\-L7)\-:

\$ git clone -\/b pip-\/centos7 \href{mailto:git@git.sys.aics.riken.jp}{\tt git@git.\-sys.\-aics.\-riken.\-jp}\-:software/\-P\-I\-P-\/gdb

Ftech source tree (Cent\-O\-S8 or R\-H\-E\-L8)\-:

\$ git clone -\/b pip-\/centos8 \href{mailto:git@git.sys.aics.riken.jp}{\tt git@git.\-sys.\-aics.\-riken.\-jp}\-:software/\-P\-I\-P-\/gdb

Build Pi\-P-\/gdb

\$ cd G\-L\-I\-B\-C\-\_\-\-S\-R\-C\-\_\-\-D\-I\-R \$ ./build.sh --prefix=G\-L\-I\-B\-C\-\_\-\-I\-N\-S\-T\-A\-L\-L\-\_\-\-D\-I\-R --with-\/pip=P\-I\-P\-\_\-\-I\-N\-S\-T\-A\-L\-L\-\_\-\-D\-I\-R

The prefix directory of Pi\-P-\/gdb can be the same with the prefix directory of Pi\-P library.
\end{DoxyEnumerate}

\subsection*{Installation from R\-P\-Ms}

R\-P\-M packages and their yum repository are also available for Cent\-O\-S 7 / R\-H\-E\-L7. \begin{DoxyVerb}$ sudo rpm -Uvh https://git.sys.r-ccs.riken.jp/PiP/package/el/7/noarch/pip-1/pip-release-N-0.noarch.rpm
$ sudo yum install pip-glibc
$ sudo yum install pip pip-debuginfo
$ sudo yum install pip-gdb
\end{DoxyVerb}


If Pi\-P packages are installed by the above R\-P\-Ms, {\bfseries P\-I\-P\-\_\-\-I\-N\-S\-T\-A\-L\-L\-\_\-\-D\-I\-R} is \char`\"{}/usr.\char`\"{}

\section*{Pi\-P documents}

The following Pi\-P documents are created by using \href{https://www.doxygen.nl/}{\tt Doxygen}.

\subsection*{Man pages}

Man pages will be installed at {\bfseries P\-I\-P\-\_\-\-I\-N\-S\-T\-A\-L\-L\-\_\-\-D\-I\-R}/share/man. \begin{DoxyVerb}$ man -M PIP_INSTALL_DIR/share/man 7 libpip
\end{DoxyVerb}


Or, use the pip-\/man command (from v2). \begin{DoxyVerb}$ PIP_INSTALL_DIR/bin/pip-man 7 libpip
\end{DoxyVerb}


The above two exammples will show you the same document you are reading.

\subsection*{P\-D\-F}

P\-D\-F documents will be installed at {\bfseries P\-I\-P\-\_\-\-I\-N\-S\-T\-A\-L\-L\-\_\-\-D\-I\-R}/share/doc/pip/pdf.

\section*{Getting Started}

\subsection*{Compile and link your Pi\-P programs}


\begin{DoxyItemize}
\item pipcc(1) command (since v2)
\end{DoxyItemize}

You can use pipcc(1) command to compile and link your Pi\-P programs. \begin{DoxyVerb}$ pipcc -Wall -O2 -g -c pip-prog.c
$ pipcc -Wall -O2 -g -o pip-prog pip-prog.c
\end{DoxyVerb}


\subsection*{Run your Pi\-P programs}


\begin{DoxyItemize}
\item pip-\/exec(1) command (piprun(1) in Pi\-P v1)
\end{DoxyItemize}

Let's assume your that have a non-\/\-Pi\-P program(s) and wnat to run as Pi\-P tasks. All you have to do is to compile your program by using the above pipcc(1) command and to use the pip-\/exec(1) command to run your program as Pi\-P tasks. \begin{DoxyVerb}$ pipcc myprog.c -o myprog
$ pip-exec -n 8 ./myprog
$ ./myprog
\end{DoxyVerb}


In this case, the pip-\/exec(1) command becomes the Pi\-P root and your program runs as 8 Pi\-P tasks. Your program can also run as a normal (non-\/\-Pi\-P) program without using the pip-\/exec(1) command. Note that the 'myprog.\-c' may or may not call any Pi\-P functions.

You may write your own Pi\-P programs whcih includes the Pi\-P root programming. In this case, your program can run without using the pip-\/exec(1) command.

If you get the following message when you try to run your program; \begin{DoxyVerb}PiP-ERR(19673) './myprog' is not PIE
\end{DoxyVerb}


Then this means that the 'myprog' is not compiled by using the pipcc(1) command properly. You may check if your program(s) can run as a Pi\-P root and/or Pi\-P task by using the pip-\/check(1) command (from v2); \begin{DoxyVerb}$ pip-check a.out
a.out : Root&Task
\end{DoxyVerb}


Above example shows that the 'a.\-out' program can run as a Pi\-P root and Pi\-P tasks.


\begin{DoxyItemize}
\item pips(1) command (from v2)

You can check if your Pi\-P program is running or not by using the pips(1) command.
\end{DoxyItemize}

List the Pi\-P tasks via the 'ps' command; \begin{DoxyVerb}$ pips -l [ COMMAND ]
\end{DoxyVerb}


or, show the activities of Pi\-P tasks via the 'top' command; \begin{DoxyVerb}$ pips -t [ COMMAND ]
\end{DoxyVerb}


Here {\bfseries C\-O\-M\-M\-A\-N\-D} is the name (not a path) of Pi\-P program you are running.

Additionally you can kill all of your Pi\-P tasks by using the same pips(1) command; \begin{DoxyVerb}$ pips -s KILL [ COMMAND ]
\end{DoxyVerb}


\subsection*{Debugging your Pi\-P programs by the pip-\/gdb command}

The following procedure attaches all Pi\-P tasks, which are created by same Pi\-P root task, as G\-D\-B inferiors. \begin{DoxyVerb}$ pip-gdb
(gdb) attach PID
\end{DoxyVerb}


The attached inferiors can be seen by the following G\-D\-B command\-: \begin{DoxyVerb}(gdb) info inferiors
  Num  Description              Executable
  4    process 6453 (pip 2)     /somewhere/pip-task-2
  3    process 6452 (pip 1)     /somewhere/pip-task-1
  2    process 6451 (pip 0)     /somewhere/pip-task-0
* 1    process 6450 (pip root)  /somewhere/pip-root
\end{DoxyVerb}


You can select and debug an inferior by the following G\-D\-B command\-: \begin{DoxyVerb}(gdb) inferior 2
[Switching to inferior 2 [process 6451 (pip 0)] (/somewhere/pip-task-0)]
\end{DoxyVerb}


When an already-\/attached program calls '\hyperlink{group__pip-1-spawn_gae9187ea22ecf0623fa3ecfba5337f52d}{pip\-\_\-spawn()}' and becomes a Pi\-P root task, the newly created Pi\-P child tasks aren't attached automatically, but you can add empty inferiors and then attach the Pi\-P child tasks to the inferiors. e.\-g. \begin{DoxyVerb}.... type Control-Z to stop the root task.
^Z
Program received signal SIGTSTP, Stopped (user).

(gdb) add-inferior
Added inferior 2
(gdb) inferior 2
(gdb) attach 1902

(gdb) add-inferior
Added inferior 3
(gdb) inferior 3
(gdb) attach 1903

(gdb) add-inferior
Added inferior 4
(gdb) inferior 4
(gdb) attach 1904

(gdb) info inferiors
  Num  Description              Executable
* 4    process 1904 (pip 2)     /somewhere/pip-task-2
  3    process 1903 (pip 1)     /somewhere/pip-task-1
  2    process 1902 (pip 0)     /somewhere/pip-task-0
  1    process 1897 (pip root)  /somewhere/pip-root
\end{DoxyVerb}


You can attach all relevant Pi\-P tasks by\-: \begin{DoxyVerb}$ pip-gdb -p PID-of-your-PiP-program
\end{DoxyVerb}


(from v2)

If the P\-I\-P\-\_\-\-G\-D\-B\-\_\-\-P\-A\-T\-H environment is set to the path pointing to Pi\-P-\/gdb executable file, then Pi\-P-\/gdb is automatically attached when an excetion signal (S\-I\-G\-S\-E\-G\-V and S\-I\-G\-H\-U\-P by default) is delivered. The exception signals can also be defined by setting the P\-I\-P\-\_\-\-G\-D\-B\-\_\-\-S\-I\-G\-N\-A\-L\-S environment. Signal names (case insensitive) can be concatenated by the '+' or '-\/' symbol. 'all' is reserved to specify most of the signals. For example, 'A\-L\-L-\/\-T\-E\-R\-M' means all signals excepting S\-I\-G\-T\-E\-R\-M, another example, 'P\-I\-P\-E+\-I\-N\-T' means S\-I\-G\-P\-I\-P\-E and S\-I\-G\-I\-N\-T. If one of the defined or default signals is delivered, then Pi\-P-\/gdb will be attached. The Pi\-P-\/gdb will show backtrace by default. If users specify P\-I\-P\-\_\-\-G\-D\-B\-\_\-\-C\-O\-M\-M\-A\-N\-D that a filename containing some G\-D\-B commands, then those G\-D\-B commands will be executed by the G\-D\-B, instead of backtrace, in batch mode. If the P\-I\-P\-\_\-\-S\-T\-O\-P\-\_\-\-O\-N\-\_\-\-S\-T\-A\-R\-T environment is set (to any value), then the Pi\-P library delivers S\-I\-G\-S\-T\-O\-P to a spawned Pi\-P task which is about to start user program.

\section*{Mailing List}

\href{mailto:pip@ml.riken.jp}{\tt pip@ml.\-riken.\-jp}

\section*{Publications}

\subsection*{Research papers}

A. Hori, M. Si, B. Gerofi, M. Takagi, J. Dayal, P. Balaji, and Y. Ishikawa. \char`\"{}\-Process-\/in-\/process\-: techniques for practical address-\/space sharing,\char`\"{} In Proceedings of the 27th International Symposium on High-\/\-Performance Parallel and Distributed Computing (H\-P\-D\-C '18). A\-C\-M, New York, N\-Y, U\-S\-A, 131-\/143. D\-O\-I\-: \href{https://doi.org/10.1145/3208040.3208045}{\tt https\-://doi.\-org/10.\-1145/3208040.\-3208045}

\subsection*{Presentation Slides}


\begin{DoxyItemize}
\item \mbox{[}H\-P\-D\-C'18\mbox{]} \href{file:/home/ahori/PiP/x86_64/pip-1-1/install/share/slides/HPDC18.pdf}{\tt file\-:/home/ahori/\-Pi\-P/x86\-\_\-64/pip-\/1-\/1/install/share/slides/\-H\-P\-D\-C18.\-pdf}
\item \mbox{[}R\-O\-S\-S'18\mbox{]} \href{file:/home/ahori/PiP/x86_64/pip-1-1/install/share/slides/HPDC18-ROSS.pdf}{\tt file\-:/home/ahori/\-Pi\-P/x86\-\_\-64/pip-\/1-\/1/install/share/slides/\-H\-P\-D\-C18-\/\-R\-O\-S\-S.\-pdf}
\item \mbox{[}I\-P\-D\-P\-S/\-R\-A\-D\-R'20\mbox{]} \href{file:/home/ahori/PiP/x86_64/pip-1-1/install/share/slides/IPDPS-RSADR-2020.pdf}{\tt file\-:/home/ahori/\-Pi\-P/x86\-\_\-64/pip-\/1-\/1/install/share/slides/\-I\-P\-D\-P\-S-\/\-R\-S\-A\-D\-R-\/2020.\-pdf} \section*{Author}
\end{DoxyItemize}

Atsushi Hori \par
Riken Center for Commputational Science (R-\/\-C\-C\-S) \par
Japan \par
